name: Build Windows Release

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      release_tag:
        description: "Release tag to update (e.g., v1.0.0). Leave empty to skip upload."
        required: false
        type: string

jobs:
  build-windows:
    runs-on: windows-latest

    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter with caching
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"
          flutter-version: "3.38.4"
          cache: true
          cache-key: "flutter-:os:-:channel:-:version:-:arch:-:hash:"
          cache-path: ${{ runner.tool_cache }}/flutter

      - name: Disable Windows Defender (performance)
        shell: powershell
        run: |
          Set-MpPreference -DisableRealtimeMonitoring $true -ErrorAction SilentlyContinue
          Set-MpPreference -ExclusionPath "${{ github.workspace }}" -ErrorAction SilentlyContinue
          Write-Host "Excluded workspace from Windows Defender"

      - name: Install dependencies
        run: |
          flutter config --no-analytics
          flutter pub get

      - name: Patch speech_to_text_windows headers
        shell: powershell
        run: |
          $publicHdr = "windows/flutter/ephemeral/.plugin_symlinks/speech_to_text_windows/windows/include/speech_to_text_windows/speech_to_text_windows.h"
          if (Test-Path $publicHdr) {
            (Get-Content $publicHdr) -replace "FLUTTER_PLUGIN_LOCAL_AUTH_WINDOWS_PLUGIN_H_", "FLUTTER_PLUGIN_SPEECH_TO_TEXT_WINDOWS_PUBLIC_H_" | Set-Content $publicHdr
          }

      - name: Create .env file
        shell: powershell
        run: |
          New-Item -Path . -Name ".env" -ItemType "file" -Force
          Add-Content -Path .env -Value "DMZ_KEY=${{ secrets.DMZ_KEY }}"

      - name: Build Windows Release
        run: flutter build windows --release

      - name: Create Inno Setup Installer
        shell: powershell
        run: |
          # Download and install Inno Setup (cached by runner)
          $innoPath = "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"
          if (-not (Test-Path $innoPath)) {
            Write-Host "Installing Inno Setup..."
            Invoke-WebRequest -Uri "https://jrsoftware.org/download.php/is.exe" -OutFile "$env:TEMP\innosetup.exe"
            Start-Process -FilePath "$env:TEMP\innosetup.exe" -ArgumentList "/VERYSILENT /SUPPRESSMSGBOXES /NORESTART /SP-" -Wait
          }

          # Create installer script
          @'
          #define MyAppName "Terrestrial Forest Monitor"
          #define MyAppVersion "1.0.48"
          #define MyAppPublisher "Gr√ºnecho e.U."
          #define MyAppExeName "terrestrial_forest_monitor.exe"

          [Setup]
          AppId={{8F3A7D2E-9B4C-4E1A-A5F6-2D8E9C7B1A3F}
          AppName={#MyAppName}
          AppVersion={#MyAppVersion}
          AppPublisher={#MyAppPublisher}
          DefaultDirName={autopf}\{#MyAppName}
          DefaultGroupName={#MyAppName}
          AllowNoIcons=yes
          OutputDir=build\windows\x64\runner\Release
          OutputBaseFilename=TFM-Setup
          Compression=lzma2
          SolidCompression=yes
          WizardStyle=modern
          PrivilegesRequired=lowest
          ArchitecturesAllowed=x64compatible
          ArchitecturesInstallIn64BitMode=x64compatible
          UninstallDisplayIcon={app}\{#MyAppExeName}

          [Languages]
          Name: "english"; MessagesFile: "compiler:Default.isl"
          Name: "german"; MessagesFile: "compiler:Languages\German.isl"

          [Tasks]
          Name: "desktopicon"; Description: "{cm:CreateDesktopIcon}"; GroupDescription: "{cm:AdditionalIcons}"

          [Files]
          Source: "build\windows\x64\runner\Release\*"; DestDir: "{app}"; Flags: ignoreversion recursesubdirs createallsubdirs

          [Icons]
          Name: "{group}\{#MyAppName}"; Filename: "{app}\{#MyAppExeName}"
          Name: "{autodesktop}\{#MyAppName}"; Filename: "{app}\{#MyAppExeName}"; Tasks: desktopicon

          [Run]
          Filename: "{app}\{#MyAppExeName}"; Description: "{cm:LaunchProgram,{#MyAppName}}"; Flags: nowait postinstall skipifsilent
          '@ | Out-File -FilePath "installer.iss" -Encoding UTF8

          # Compile installer
          & $innoPath installer.iss

      - name: Upload artifacts to release
        uses: softprops/action-gh-release@v2
        if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && inputs.release_tag != '')
        with:
          tag_name: ${{ github.event_name == 'release' && github.event.release.tag_name || inputs.release_tag }}
          files: build/windows/x64/runner/Release/TFM-Setup.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Re-enable Windows Defender
        if: always()
        shell: powershell
        run: |
          Set-MpPreference -DisableRealtimeMonitoring $false -ErrorAction SilentlyContinue
