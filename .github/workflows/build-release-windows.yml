name: Build Windows Release

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      release_tag:
        description: "Release tag to update (e.g., v1.0.0). Leave empty to skip upload."
        required: false
        type: string

jobs:
  prepare-cache:
    runs-on: windows-latest

    env:
      PUB_CACHE: C:\tmp\.pub-cache-${{ github.run_id }}-${{ github.run_attempt }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"
          flutter-version: "3.38.4"
          cache: false

      - name: Disable Windows Defender real-time protection
        shell: powershell
        run: |
          Set-MpPreference -DisableRealtimeMonitoring $true -ErrorAction SilentlyContinue
          Set-MpPreference -ExclusionPath $env:PUB_CACHE -ErrorAction SilentlyContinue

      - name: Resolve dependencies (Windows)
        shell: powershell
        run: |
          $pubCache = $env:PUB_CACHE
          Write-Host "Using PUB_CACHE: $pubCache"

          if (-not (Test-Path $pubCache)) {
            New-Item -ItemType Directory -Force -Path $pubCache | Out-Null
          }

          flutter config --no-analytics

          $maxRetries = 5
          $retryCount = 0
          $success = $false

          while (-not $success -and $retryCount -lt $maxRetries) {
            $retryCount++
            Write-Host "Attempt $retryCount of $maxRetries..."

            # Kill processes that may hold locks
            Get-Process | Where-Object { $_.ProcessName -match "^(dart|flutter|pub|flutter_tester)$" } | Stop-Process -Force -ErrorAction SilentlyContinue
            Start-Sleep -Seconds 3

            # Clear caches to avoid stale locks
            if (Test-Path $pubCache) {
              Remove-Item -Recurse -Force $pubCache -ErrorAction SilentlyContinue
            }
            New-Item -ItemType Directory -Force -Path $pubCache | Out-Null

            $hostedCache = Join-Path $env:FLUTTER_ROOT ".pub-cache"
            if (Test-Path $hostedCache) {
              Remove-Item -Recurse -Force $hostedCache -ErrorAction SilentlyContinue
            }
            $userCache = Join-Path $env:LOCALAPPDATA "Pub\Cache"
            if (Test-Path $userCache) {
              Remove-Item -Recurse -Force $userCache -ErrorAction SilentlyContinue
            }
            Start-Sleep -Seconds 5

            try {
              flutter clean
              flutter pub get

              if ($LASTEXITCODE -eq 0) {
                $success = $true
                Write-Host "Dependencies installed successfully"
              } else {
                throw "Exit code $LASTEXITCODE"
              }
            } catch {
              Write-Host "Error: $_"
              if ($retryCount -lt $maxRetries) {
                $backoff = 15 * $retryCount
                Write-Host "Retrying in $backoff seconds..."
                Start-Sleep -Seconds $backoff
              }
            }
          }

          if (-not $success) { throw "Failed to install dependencies" }

      - name: Package pub cache
        shell: powershell
        run: |
          $cacheDir = $env:PUB_CACHE
          $pkgCfg = ".dart_tool/package_config.json"
          $items = @()
          if (Test-Path $cacheDir) { $items += $cacheDir }
          if (Test-Path $pkgCfg) { $items += $pkgCfg }
          if ($items.Count -eq 0) {
            Write-Host "No pub cache found; creating empty archive"
            New-Item -ItemType File -Force pub-cache.tgz | Out-Null
          } else {
            tar -czf pub-cache.tgz $items
          }

      - name: Upload cache artifact
        uses: actions/upload-artifact@v4
        with:
          name: flutter-pub-cache
          path: pub-cache.tgz

  build-windows:
    runs-on: windows-latest
    needs: prepare-cache

    permissions:
      contents: write

    env:
      PUB_CACHE: C:\tmp\.pub-cache-${{ github.run_id }}-${{ github.run_attempt }}
      PFX_PASSWORD: ${{ secrets.PFX_PASSWORD }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Restore code-signing certificate (PFX)
        if: env.PFX_PASSWORD != ''
        shell: powershell
        run: |
          if (-not $env:PFX_BASE64) {
            Write-Error "Missing secret: PFX_BASE64"; exit 1
          }
          if (-not $env:PFX_PASSWORD) {
            Write-Error "Missing secret: PFX_PASSWORD"; exit 1
          }

          $pfxPath = "windows_signing.pfx"
          [IO.File]::WriteAllBytes($pfxPath, [Convert]::FromBase64String($env:PFX_BASE64))
          Write-Host "Restored code-signing certificate to $pfxPath"


      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"
          flutter-version: "3.38.4"
          cache: false

      - name: Disable Windows Defender real-time protection
        shell: powershell
        run: |
          Set-MpPreference -DisableRealtimeMonitoring $true -ErrorAction SilentlyContinue
          Set-MpPreference -ExclusionPath $env:PUB_CACHE -ErrorAction SilentlyContinue
          Write-Host "Windows Defender real-time protection disabled"

      - name: Download pub cache artifact
        uses: actions/download-artifact@v4
        with:
          name: flutter-pub-cache
          path: C:\tmp

      - name: Extract pub cache
        shell: powershell
        run: |
          tar -xf C:\tmp\pub-cache.tgz -C C:\tmp
          # Ensure PUB_CACHE dir exists
          New-Item -ItemType Directory -Force -Path $env:PUB_CACHE | Out-Null

          # Locate extracted .pub-cache anywhere under C:\tmp
          $cacheDir = Get-ChildItem -Directory -Recurse -Path C:\tmp -Filter ".pub-cache" -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($cacheDir) {
            Remove-Item -Recurse -Force $env:PUB_CACHE -ErrorAction SilentlyContinue
            Move-Item -Force $cacheDir.FullName $env:PUB_CACHE
          } else {
            Write-Host "Warning: .pub-cache not found in extracted artifact"
          }

          # Restore package_config.json from any location under C:\tmp
          $pkgConfig = Get-ChildItem -Recurse -Path C:\tmp -Filter "package_config.json" -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($pkgConfig) {
            New-Item -ItemType Directory -Force -Path ".dart_tool" | Out-Null
            Copy-Item -Force $pkgConfig.FullName ".dart_tool\package_config.json"
          } else {
            Write-Host "Warning: package_config.json not found in extracted artifact"
          }

      - name: Install dependencies
        shell: powershell
        run: |
          flutter config --no-analytics
          flutter pub get

      - name: Verify SSL certificate bundle
        shell: powershell
        run: |
          Write-Host "Verifying ci.thuenen.de SSL certificate is bundled with app..."

          $certPath = "assets/certs/ci_thuenen_root.pem"

          if (Test-Path $certPath) {
            $cert = Get-Content $certPath -Raw
            Write-Host "Certificate found and will be bundled with app"
            Write-Host "Certificate file: $certPath"
            Write-Host "Size: $((Get-Item $certPath).Length) bytes"
          } else {
            Write-Host "Warning: Certificate not found at $certPath"
            Write-Host "App will use fallback badCertificateCallback"
          }

      - name: Patch speech_to_text_windows headers (CI workaround)
        shell: powershell
        run: |
          # Patch public header guard collision
          $publicHdr = "windows/flutter/ephemeral/.plugin_symlinks/speech_to_text_windows/windows/include/speech_to_text_windows/speech_to_text_windows.h"
          if (Test-Path $publicHdr) {
            (Get-Content $publicHdr) -replace "FLUTTER_PLUGIN_LOCAL_AUTH_WINDOWS_PLUGIN_H_", "FLUTTER_PLUGIN_SPEECH_TO_TEXT_WINDOWS_PUBLIC_H_" | Set-Content $publicHdr
            Write-Host "Patched public header guard in $publicHdr"
          } else {
            Write-Host "Public header not found: $publicHdr"
          }

          # Ensure plugin header has correct guard
          $pluginHdr = "windows/flutter/ephemeral/.plugin_symlinks/speech_to_text_windows/windows/speech_to_text_windows_plugin.h"
          if (Test-Path $pluginHdr) {
            $content = Get-Content $pluginHdr -Raw
            if ($content -notmatch "namespace speech_to_text_windows") {
              Write-Host "WARNING: Plugin header missing namespace declaration"
            } else {
              Write-Host "Plugin header looks OK"
            }
          } else {
            Write-Host "Plugin header not found: $pluginHdr"
          }

      - name: Enable Windows desktop
        run: flutter config --enable-windows-desktop

      - name: Create .env file
        shell: powershell
        run: |
          New-Item -Path . -Name ".env" -ItemType "file" -Force
          Add-Content -Path .env -Value "DMZ_KEY=${{ secrets.DMZ_KEY }}"

      - name: Build Windows Release
        run: flutter build windows --release

      - name: Export public certificate (.cer)
        if: env.PFX_PASSWORD != ''
        shell: powershell
        run: |
          $pfxPath = "windows_signing.pfx"
          if (-not (Test-Path $pfxPath)) { throw "PFX not found at $pfxPath" }

          $cert = New-Object System.Security.Cryptography.X509Certificates.X509Certificate2($pfxPath, $env:PFX_PASSWORD)
          $cerPath = "build/windows/x64/runner/Release/terrestrial_forest_monitor.cer"
          Export-Certificate -Cert $cert -FilePath $cerPath | Out-Null
          Write-Host "Exported CER to $cerPath"

      - name: Build MSIX (Sideload)
        run: >
          dart run msix:create
          --build-windows false
          --store false
          --install-certificate false
          --certificate-path windows_signing.pfx
          --certificate-password "$PFX_PASSWORD"

      - name: Rename Sideload MSIX
        shell: powershell
        run: |
          $sideloadMsix = Get-ChildItem build/windows/x64/runner/Release/*.msix | Select-Object -First 1
          if ($sideloadMsix) {
            Rename-Item $sideloadMsix.FullName -NewName "terrestrial_forest_monitor_sideload.msix"
            Write-Host "Renamed sideload MSIX to: terrestrial_forest_monitor_sideload.msix"
          } else {
            Write-Host "Warning: No sideload MSIX file found"
          }

          # Also rename the certificate file for clarity
          $cerFile = Get-ChildItem build/windows/x64/runner/Release/*.cer | Select-Object -First 1
          if ($cerFile) {
            Rename-Item $cerFile.FullName -NewName "terrestrial_forest_monitor.cer"
            Write-Host "Renamed certificate to: terrestrial_forest_monitor.cer"
          } else {
            Write-Host "Warning: No certificate file found"
          }

      - name: Build MSIX (Store)
        run: >
          dart run msix:create
          --build-windows false
          --store
          --install-certificate false
          --certificate-path windows_signing.pfx
          --certificate-password "$PFX_PASSWORD"

      - name: Install Microsoft Store CLI
        uses: microsoft/setup-msstore-cli@v1

      #- name: Configure Microsoft Store CLI
      #  shell: powershell
      #  run: |
      #      $tenant = '${{ secrets.MS_TENANT_ID }}'
      #      $seller = '${{ secrets.MS_SELLER_ID }}'
      #      $clientId = '${{ secrets.MS_CLIENT_ID }}'
      #      $clientSecret = '${{ secrets.MS_CLIENT_SECRET }}'
      #
      #      if ([string]::IsNullOrWhiteSpace($tenant)) { Write-Error "Missing secret: MS_TENANT_ID"; exit 1 }
      #      if ([string]::IsNullOrWhiteSpace($seller)) { Write-Error "Missing secret: MS_SELLER_ID"; exit 1 }
      #      if ([string]::IsNullOrWhiteSpace($clientId)) { Write-Error "Missing secret: MS_CLIENT_ID"; exit 1 }
      #      if ([string]::IsNullOrWhiteSpace($clientSecret)) { Write-Error "Missing secret: MS_CLIENT_SECRET"; exit 1 }
      #
      #      msstore settings --tenantId $tenant --sellerId $seller --clientId $clientId --clientSecret $clientSecret
      #
      #- name: Show msstore settings (debug)
      #  run: msstore settings show
      #
      #- name: Publish to Microsoft Store
      #  shell: powershell
      #  run: |
      #      $storeMsix = Get-ChildItem build/windows/x64/runner/Release/*.msix | Where-Object { $_.Name -notlike "*sideload*" } | Select-Object -First 1
      #      if (-not $storeMsix) { throw "No store MSIX found" }
      #      msstore publish --path "$($storeMsix.FullName)" --productId ${{ secrets.MS_PRODUCT_ID }}

      - name: Create portable ZIP archive
        uses: thedoctor0/zip-release@0.7.6
        with:
          type: "zip"
          filename: "TFM-windows-portable.zip"
          directory: build/windows/x64/runner/Release

      - name: Upload artifacts to release
        uses: softprops/action-gh-release@v2
        if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && inputs.release_tag != '')
        with:
          tag_name: ${{ github.event_name == 'release' && github.event.release.tag_name || inputs.release_tag }}
          files: |
            build/windows/x64/runner/Release/TFM-windows-portable.zip
            build/windows/x64/runner/Release/*.msix
            build/windows/x64/runner/Release/*.cer
            install.bat
            install_certificate.ps1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Re-enable Windows Defender
        if: always()
        shell: powershell
        run: |
          Set-MpPreference -DisableRealtimeMonitoring $false -ErrorAction SilentlyContinue
          Write-Host "Windows Defender real-time protection re-enabled"
