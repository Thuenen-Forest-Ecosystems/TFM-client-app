name: Build Windows Release

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      release_tag:
        description: "Release tag to update (e.g., v1.0.0). Leave empty to skip upload."
        required: false
        type: string

jobs:
  build-windows:
    runs-on: windows-latest
    timeout-minutes: 60

    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter with caching
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"
          flutter-version: "3.38.4"
          cache: true
          cache-key: "flutter-:os:-:channel:-:version:-:arch:-:hash:"
          cache-path: ${{ runner.tool_cache }}/flutter

      - name: Disable Windows Defender (performance)
        shell: powershell
        continue-on-error: true
        run: |
          try {
            Set-MpPreference -DisableRealtimeMonitoring $true -ErrorAction SilentlyContinue
            Set-MpPreference -ExclusionPath "${{ github.workspace }}" -ErrorAction SilentlyContinue
            Write-Host "Excluded workspace from Windows Defender"
          } catch {
            Write-Host "Warning: Could not modify Windows Defender settings (this is expected on some runners)"
          }

      - name: Enable flutter_libserialport for Windows
        shell: powershell
        run: |
          # Uncomment flutter_libserialport dependencies for Windows build
          $pubspecPath = "pubspec.yaml"
          $content = Get-Content $pubspecPath -Raw

          # Uncomment flutter_libserialport in dependencies
          $content = $content -replace "#flutter_libserialport: \^0\.6\.0", "flutter_libserialport: ^0.6.0"

          # Uncomment flutter_libserialport in dependency_overrides
          $content = $content -replace "#flutter_libserialport:", "flutter_libserialport:"
          $content = $content -replace "#  git:", "  git:"
          $content = $content -replace "#    url: https://github.com/NeariX67/flutter_libserialport", "    url: https://github.com/NeariX67/flutter_libserialport"
          $content = $content -replace "#    ref: main", "    ref: main"

          Set-Content $pubspecPath -Value $content
          Write-Host "Enabled flutter_libserialport for Windows build"

      - name: Install dependencies
        timeout-minutes: 10
        run: |
          flutter config --no-analytics
          flutter pub get

      - name: Patch speech_to_text_windows headers
        shell: powershell
        run: |
          $publicHdr = "windows/flutter/ephemeral/.plugin_symlinks/speech_to_text_windows/windows/include/speech_to_text_windows/speech_to_text_windows.h"
          if (Test-Path $publicHdr) {
            (Get-Content $publicHdr) -replace "FLUTTER_PLUGIN_LOCAL_AUTH_WINDOWS_PLUGIN_H_", "FLUTTER_PLUGIN_SPEECH_TO_TEXT_WINDOWS_PUBLIC_H_" | Set-Content $publicHdr
          }

      - name: Create .env file
        shell: powershell
        run: |
          New-Item -Path . -Name ".env" -ItemType "file" -Force
          Add-Content -Path .env -Value "DMZ_KEY=${{ secrets.DMZ_KEY }}"

      - name: Build Windows Release
        timeout-minutes: 20
        run: flutter build windows --release --verbose

      - name: Copy certificate helper script
        shell: powershell
        run: |
          # Create PowerShell script to install certificates
          $scriptPath = "build\windows\x64\runner\Release\install-certificates.ps1"
          @'
          # Install SSL Certificates for Terrestrial Forest Monitor
          # This script installs the required CA certificates to Windows Certificate Store

          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host "TFM Certificate Installer" -ForegroundColor Cyan
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host ""

          $certPath = Join-Path $PSScriptRoot "data\flutter_assets\assets\certs\ca-bundle.pem"

          if (-not (Test-Path $certPath)) {
              Write-Host "ERROR: Certificate file not found: $certPath" -ForegroundColor Red
              Read-Host "Press Enter to exit"
              exit 1
          }

          Write-Host "Certificate file: $certPath" -ForegroundColor Green
          Write-Host ""

          # Read and split the certificate bundle
          $certContent = Get-Content $certPath -Raw
          $certs = $certContent -split "(?=-----BEGIN CERTIFICATE-----)"

          $installed = 0
          $failed = 0

          foreach ($cert in $certs) {
              if ($cert -match "BEGIN CERTIFICATE") {
                  try {
                      $tempCert = [System.IO.Path]::GetTempFileName() + ".crt"
                      $cert | Set-Content $tempCert -Encoding ASCII

                      $certObj = New-Object System.Security.Cryptography.X509Certificates.X509Certificate2
                      $certObj.Import($tempCert)

                      $store = New-Object System.Security.Cryptography.X509Certificates.X509Store("Root", "CurrentUser")
                      $store.Open("ReadWrite")

                      $existing = $store.Certificates | Where-Object { $_.Thumbprint -eq $certObj.Thumbprint }
                      
                      if ($existing) {
                          Write-Host "  [SKIP] Already installed: $($certObj.Subject)" -ForegroundColor Yellow
                      } else {
                          $store.Add($certObj)
                          Write-Host "  [OK] Installed: $($certObj.Subject)" -ForegroundColor Green
                          $installed++
                      }

                      $store.Close()
                      Remove-Item $tempCert -ErrorAction SilentlyContinue

                  } catch {
                      Write-Host "  [ERROR] Failed to install certificate: $_" -ForegroundColor Red
                      $failed++
                  }
              }
          }

          Write-Host ""
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host "Installed: $installed | Failed: $failed" -ForegroundColor Cyan
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host ""
          Read-Host "Press Enter to exit"
          '@ | Out-File -FilePath $scriptPath -Encoding UTF8
          Write-Host "Certificate helper script created"

      - name: Create README for users
        shell: powershell
        run: |
          $readmePath = "build\windows\x64\runner\Release\README.txt"
          @'
          Terrestrial Forest Monitor - Windows Application
          =================================================

          RUNNING THE APPLICATION:
          - Double-click terrestrial_forest_monitor.exe to run the app
          - No installation required - this is a portable version

          SSL CERTIFICATE SETUP (if needed):
          - Run install-certificates.ps1 to install SSL certificates
          - Right-click -> "Run with PowerShell"
          - This is only needed if you have connection issues

          SYSTEM REQUIREMENTS:
          - Windows 10 or later (x64)
          - Visual C++ Redistributable (usually pre-installed)
          - If the app doesn't start, download and install:
            https://aka.ms/vs/17/release/vc_redist.x64.exe

          '@ | Out-File -FilePath $readmePath -Encoding UTF8
          Write-Host "README created"

      - name: Package Windows build
        shell: powershell
        run: |
          $version = "1.0.61"
          $zipName = "TFM-Windows-v$version.zip"
          $sourcePath = "build\windows\x64\runner\Release"

          Write-Host "Creating package: $zipName"
          Compress-Archive -Path "$sourcePath\*" -DestinationPath $zipName -Force

          $size = (Get-Item $zipName).Length / 1MB
          Write-Host "Package created: $zipName ($([math]::Round($size, 2)) MB)"

      - name: Upload artifacts to release
        uses: softprops/action-gh-release@v2
        if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && inputs.release_tag != '')
        with:
          tag_name: ${{ github.event_name == 'release' && github.event.release.tag_name || inputs.release_tag }}
          files: TFM-Windows-v*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Re-enable Windows Defender
        if: always()
        continue-on-error: true
        shell: powershell
        run: |
          try {
            Set-MpPreference -DisableRealtimeMonitoring $false -ErrorAction SilentlyContinue
            Write-Host "Re-enabled Windows Defender"
          } catch {
            Write-Host "Warning: Could not re-enable Windows Defender"
          }
