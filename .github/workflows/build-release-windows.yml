name: Build Windows Release

on:
    release:
        types: [published]
    workflow_dispatch:

jobs:
    build-windows:
        runs-on: windows-latest

        permissions:
            contents: write

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Flutter
              uses: subosito/flutter-action@v2
              with:
                  channel: "stable"
                  flutter-version: "3.38.4"
                  cache: false

            - name: Disable Windows Defender real-time protection
              shell: powershell
              run: |
                  Set-MpPreference -DisableRealtimeMonitoring $true -ErrorAction SilentlyContinue
                  Write-Host "Windows Defender real-time protection disabled"

            - name: Install dependencies
              shell: powershell
              run: |
                  # Set local PUB_CACHE to avoid locking issues in hosted tool cache
                  $localPubCache = Join-Path $env:GITHUB_WORKSPACE ".pub-cache"
                  $env:PUB_CACHE = $localPubCache
                  Write-Host "Using local PUB_CACHE: $localPubCache"

                  # Persist for subsequent steps
                  echo "PUB_CACHE=$localPubCache" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8

                  flutter config --no-analytics

                  $maxRetries = 5
                  $retryCount = 0
                  $success = $false

                  while (-not $success -and $retryCount -lt $maxRetries) {
                    $retryCount++
                    Write-Host "Attempt $retryCount of $maxRetries..."

                    try {
                      if ($retryCount -gt 1) {
                        Write-Host "Cleaning..."
                        flutter clean
                        if (Test-Path $localPubCache) {
                            Remove-Item -Recurse -Force $localPubCache -ErrorAction SilentlyContinue
                        }
                        Start-Sleep -Seconds 5
                      }

                      flutter pub get
                      
                      if ($LASTEXITCODE -eq 0) {
                        $success = $true
                        Write-Host "Dependencies installed successfully"
                      } else {
                        throw "Exit code $LASTEXITCODE"
                      }
                    } catch {
                      Write-Host "Error: $_"
                      Start-Sleep -Seconds 10
                    }
                  }

                  if (-not $success) { throw "Failed to install dependencies" }

            - name: Enable Windows desktop
              run: flutter config --enable-windows-desktop

            - name: Create .env file
              shell: powershell
              run: |
                  New-Item -Path . -Name ".env" -ItemType "file" -Force
                  Add-Content -Path .env -Value "DMZ_KEY=${{ secrets.DMZ_KEY }}"

            - name: Build Windows Release
              run: flutter build windows --release

            - name: Build MSIX (Sideload)
              run: dart run msix:create --build-windows false --store false --install-certificate false

            - name: Rename Sideload MSIX
              shell: powershell
              run: |
                  $sideloadMsix = Get-ChildItem build/windows/x64/runner/Release/*.msix | Select-Object -First 1
                  if ($sideloadMsix) {
                    Rename-Item $sideloadMsix.FullName -NewName "terrestrial_forest_monitor_sideload.msix"
                    Write-Host "Renamed sideload MSIX to: terrestrial_forest_monitor_sideload.msix"
                  } else {
                    Write-Host "Warning: No sideload MSIX file found"
                  }

            - name: Build MSIX (Store)
              run: dart run msix:create --build-windows false --store

            - name: Create portable ZIP archive
              uses: thedoctor0/zip-release@0.7.6
              with:
                  type: "zip"
                  filename: "TFM-windows-portable.zip"
                  directory: build/windows/x64/runner/Release

            - name: Upload artifacts to release
              uses: softprops/action-gh-release@v2
              if: github.event_name == 'release'
              with:
                  files: |
                      build/windows/x64/runner/Release/TFM-windows-portable.zip
                      build/windows/x64/runner/Release/*.msix
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Re-enable Windows Defender
              if: always()
              shell: powershell
              run: |
                  Set-MpPreference -DisableRealtimeMonitoring $false -ErrorAction SilentlyContinue
                  Write-Host "Windows Defender real-time protection re-enabled"
