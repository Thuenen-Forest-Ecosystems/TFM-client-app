name: Build Windows Release

on:
    release:
        types: [published]
    workflow_dispatch:

jobs:
    prepare-cache:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Flutter
              uses: subosito/flutter-action@v2
              with:
                  channel: "stable"
                  flutter-version: "3.38.4"
                  cache: false

            - name: Resolve dependencies (Linux)
              run: flutter pub get

            - name: Package pub cache
              run: |
                  tar -czf pub-cache.tgz .pub-cache .dart_tool/package_config.json

            - name: Upload cache artifact
              uses: actions/upload-artifact@v4
              with:
                  name: flutter-pub-cache
                  path: pub-cache.tgz

    build-windows:
        runs-on: windows-latest
        needs: prepare-cache

        permissions:
            contents: write

        env:
            PUB_CACHE: C:\tmp\.pub-cache

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Flutter
              uses: subosito/flutter-action@v2
              with:
                  channel: "stable"
                  flutter-version: "3.38.4"
                  cache: false

            - name: Disable Windows Defender real-time protection
              shell: powershell
              run: |
                  Set-MpPreference -DisableRealtimeMonitoring $true -ErrorAction SilentlyContinue
                  Write-Host "Windows Defender real-time protection disabled"

            - name: Download pub cache artifact
              uses: actions/download-artifact@v4
              with:
                  name: flutter-pub-cache
                  path: C:\tmp

            - name: Extract pub cache
              shell: powershell
              run: |
                  tar -xf C:\tmp\pub-cache.tgz -C C:\tmp
                  # Ensure PUB_CACHE dir exists
                  New-Item -ItemType Directory -Force -Path $env:PUB_CACHE | Out-Null
                  # Copy extracted cache into target location
                  if (Test-Path "C:\tmp\.pub-cache") {
                    Remove-Item -Recurse -Force $env:PUB_CACHE -ErrorAction SilentlyContinue
                    Move-Item -Force "C:\tmp\.pub-cache" $env:PUB_CACHE
                  }
                  # Restore package_config.json for offline pub get
                  if (Test-Path "C:\tmp\.dart_tool\package_config.json") {
                    New-Item -ItemType Directory -Force -Path ".dart_tool" | Out-Null
                    Copy-Item -Force "C:\tmp\.dart_tool\package_config.json" ".dart_tool\package_config.json"
                  }

            - name: Install dependencies (offline)
              shell: powershell
              run: |
                  flutter config --no-analytics
                  flutter pub get --offline

            - name: Enable Windows desktop
              run: flutter config --enable-windows-desktop

            - name: Create .env file
              shell: powershell
              run: |
                  New-Item -Path . -Name ".env" -ItemType "file" -Force
                  Add-Content -Path .env -Value "DMZ_KEY=${{ secrets.DMZ_KEY }}"

            - name: Build Windows Release
              run: flutter build windows --release

            - name: Build MSIX (Sideload)
              run: dart run msix:create --build-windows false --store false --install-certificate false

            - name: Rename Sideload MSIX
              shell: powershell
              run: |
                  $sideloadMsix = Get-ChildItem build/windows/x64/runner/Release/*.msix | Select-Object -First 1
                  if ($sideloadMsix) {
                    Rename-Item $sideloadMsix.FullName -NewName "terrestrial_forest_monitor_sideload.msix"
                    Write-Host "Renamed sideload MSIX to: terrestrial_forest_monitor_sideload.msix"
                  } else {
                    Write-Host "Warning: No sideload MSIX file found"
                  }

            - name: Build MSIX (Store)
              run: dart run msix:create --build-windows false --store

            - name: Create portable ZIP archive
              uses: thedoctor0/zip-release@0.7.6
              with:
                  type: "zip"
                  filename: "TFM-windows-portable.zip"
                  directory: build/windows/x64/runner/Release

            - name: Upload artifacts to release
              uses: softprops/action-gh-release@v2
              if: github.event_name == 'release'
              with:
                  files: |
                      build/windows/x64/runner/Release/TFM-windows-portable.zip
                      build/windows/x64/runner/Release/*.msix
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Re-enable Windows Defender
              if: always()
              shell: powershell
              run: |
                  Set-MpPreference -DisableRealtimeMonitoring $false -ErrorAction SilentlyContinue
                  Write-Host "Windows Defender real-time protection re-enabled"
