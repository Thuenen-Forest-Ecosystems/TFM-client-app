name: Build Windows Release

on:
    release:
        types: [published]
    workflow_dispatch:

jobs:
    prepare-cache:
        runs-on: windows-latest

        env:
            PUB_CACHE: C:\tmp\.pub-cache

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Flutter
              uses: subosito/flutter-action@v2
              with:
                  channel: "stable"
                  flutter-version: "3.38.4"
                  cache: false

            - name: Disable Windows Defender real-time protection
              shell: powershell
              run: |
                  Set-MpPreference -DisableRealtimeMonitoring $true -ErrorAction SilentlyContinue

            - name: Resolve dependencies (Windows)
              shell: powershell
              run: |
                  flutter pub get

            - name: Package pub cache
              shell: powershell
              run: |
                  $cacheDir = $env:PUB_CACHE
                  $pkgCfg = ".dart_tool/package_config.json"
                  $items = @()
                  if (Test-Path $cacheDir) { $items += $cacheDir }
                  if (Test-Path $pkgCfg) { $items += $pkgCfg }
                  if ($items.Count -eq 0) {
                    Write-Host "No pub cache found; creating empty archive"
                    New-Item -ItemType File -Force pub-cache.tgz | Out-Null
                  } else {
                    tar -czf pub-cache.tgz $items
                  }

            - name: Upload cache artifact
              uses: actions/upload-artifact@v4
              with:
                  name: flutter-pub-cache
                  path: pub-cache.tgz

    build-windows:
        runs-on: windows-latest
        needs: prepare-cache

        permissions:
            contents: write

        env:
            PUB_CACHE: C:\tmp\.pub-cache

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Flutter
              uses: subosito/flutter-action@v2
              with:
                  channel: "stable"
                  flutter-version: "3.38.4"
                  cache: false

            - name: Disable Windows Defender real-time protection
              shell: powershell
              run: |
                  Set-MpPreference -DisableRealtimeMonitoring $true -ErrorAction SilentlyContinue
                  Write-Host "Windows Defender real-time protection disabled"

            - name: Download pub cache artifact
              uses: actions/download-artifact@v4
              with:
                  name: flutter-pub-cache
                  path: C:\tmp

            - name: Extract pub cache
              shell: powershell
              run: |
                  tar -xf C:\tmp\pub-cache.tgz -C C:\tmp
                  # Ensure PUB_CACHE dir exists
                  New-Item -ItemType Directory -Force -Path $env:PUB_CACHE | Out-Null

                  # Locate extracted .pub-cache anywhere under C:\tmp
                  $cacheDir = Get-ChildItem -Directory -Recurse -Path C:\tmp -Filter ".pub-cache" -ErrorAction SilentlyContinue | Select-Object -First 1
                  if ($cacheDir) {
                    Remove-Item -Recurse -Force $env:PUB_CACHE -ErrorAction SilentlyContinue
                    Move-Item -Force $cacheDir.FullName $env:PUB_CACHE
                  } else {
                    Write-Host "Warning: .pub-cache not found in extracted artifact"
                  }

                  # Restore package_config.json from any location under C:\tmp
                  $pkgConfig = Get-ChildItem -Recurse -Path C:\tmp -Filter "package_config.json" -ErrorAction SilentlyContinue | Select-Object -First 1
                  if ($pkgConfig) {
                    New-Item -ItemType Directory -Force -Path ".dart_tool" | Out-Null
                    Copy-Item -Force $pkgConfig.FullName ".dart_tool\package_config.json"
                  } else {
                    Write-Host "Warning: package_config.json not found in extracted artifact"
                  }

            - name: Install dependencies (offline)
              shell: powershell
              run: |
                  flutter config --no-analytics
                  flutter pub get --offline

            - name: Enable Windows desktop
              run: flutter config --enable-windows-desktop

            - name: Create .env file
              shell: powershell
              run: |
                  New-Item -Path . -Name ".env" -ItemType "file" -Force
                  Add-Content -Path .env -Value "DMZ_KEY=${{ secrets.DMZ_KEY }}"

            - name: Build Windows Release
              run: flutter build windows --release

            - name: Build MSIX (Sideload)
              run: dart run msix:create --build-windows false --store false --install-certificate false

            - name: Rename Sideload MSIX
              shell: powershell
              run: |
                  $sideloadMsix = Get-ChildItem build/windows/x64/runner/Release/*.msix | Select-Object -First 1
                  if ($sideloadMsix) {
                    Rename-Item $sideloadMsix.FullName -NewName "terrestrial_forest_monitor_sideload.msix"
                    Write-Host "Renamed sideload MSIX to: terrestrial_forest_monitor_sideload.msix"
                  } else {
                    Write-Host "Warning: No sideload MSIX file found"
                  }

            - name: Build MSIX (Store)
              run: dart run msix:create --build-windows false --store

            - name: Install Microsoft Store CLI
              uses: microsoft/setup-msstore-cli@v1

            - name: Configure Microsoft Store CLI
              shell: powershell
              run: |
                  $tenant = '${{ secrets.MS_TENANT_ID }}'
                  $seller = '${{ secrets.MS_SELLER_ID }}'
                  $clientId = '${{ secrets.MS_CLIENT_ID }}'
                  $clientSecret = '${{ secrets.MS_CLIENT_SECRET }}'
                  msstore settings --tenantId $tenant --sellerId $seller --clientId $clientId --clientSecret $clientSecret

            - name: Show msstore settings (debug)
              run: msstore settings show

            - name: Publish to Microsoft Store
              shell: powershell
              run: |
                  $storeMsix = Get-ChildItem build/windows/x64/runner/Release/*.msix | Where-Object { $_.Name -notlike "*sideload*" } | Select-Object -First 1
                  if (-not $storeMsix) { throw "No store MSIX found" }
                  msstore publish --path "$($storeMsix.FullName)" --productId ${{ secrets.MS_PRODUCT_ID }}

            - name: Create portable ZIP archive
              uses: thedoctor0/zip-release@0.7.6
              with:
                  type: "zip"
                  filename: "TFM-windows-portable.zip"
                  directory: build/windows/x64/runner/Release

            - name: Upload artifacts to release
              uses: softprops/action-gh-release@v2
              if: github.event_name == 'release'
              with:
                  files: |
                      build/windows/x64/runner/Release/TFM-windows-portable.zip
                      build/windows/x64/runner/Release/*.msix
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Re-enable Windows Defender
              if: always()
              shell: powershell
              run: |
                  Set-MpPreference -DisableRealtimeMonitoring $false -ErrorAction SilentlyContinue
                  Write-Host "Windows Defender real-time protection re-enabled"
